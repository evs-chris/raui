<div class-rshell {{yield extra-attributes}} as-tracked=`outer` class-rshell-left-popped=".leftPop" class-rshell-right-popped=".rightPop">
  <div class-rshell-sizer as-tracked=`sizer` />
  <div class-rshell-main>
    {{#if ._top}}<div class-rshell-top class-rshell-overflow="~/topOverflow" {{#if ._topA}}{{yield ._topA}}{{/if}}>{{yield ._top}}</div>{{/if}}
    <div class-rshell-middle class-rshell-has-left="._left && !._leftOver && !.leftOver" class-rshell-has-right="._right && !._rightOver && !.rightOver" class-rshell-left-hidden=".leftHidden" class-rshell-right-hidden=".rightHidden">
      <div class-rshell-modal class-rshell-blocked=".blocked || (.blockableLeft && .leftPull) || (.blockableRight && .rightPull)"
        on-click="@.set({ leftHidden: .leftOver || ._leftOver ? true : .leftHidden, rightHidden: .rightOver || ._rightOver ? true : .rightHidden })"
        on-swipeleft({bind:'.leftPush'})="@.set('leftHidden', true)"
        on-swiperight({bind:'.rightPush'})="@.set('rightHidden', true)"
        {{#if .leftPull || .rightPull}}style-transition=none style-opacity="{{Math.min(.leftPull || .rightPull, 100) / 200}}"{{/if}}
       />
      {{#if ._left}}
        <div class-rshell-left as-tracked=`left`
          {{#if ._leftA}}{{yield ._leftA}}{{/if}}
          on-swipeleft({bind:'.leftPush'})="@.set('leftHidden', true)"
          {{#if .leftPull}}style-transition=none style-transform="translate(-{{100 - (.leftPull > 100 ? 100 : .leftPull)}}%)"{{/if}}
          {{#if .leftPush}}style-transition=none style-transform="translate(-{{.leftPush > 100 ? 100 : .leftPush}}%)"{{/if}}
          class-rshell-overflow="~/leftOverflow"
        >{{yield ._left}}</div>
      {{/if}}
      {{#if ._center}}
        <div class-rshell-center as-tracked=`center`
          {{#if ._centerA}}{{yield ._centerA}}{{/if}}
          {{#if ._left && .leftHidden}}on-swiperight({maxX:80,bind:'.leftPull'})="@.set('leftHidden', false)"{{/if}}
          {{#if ._right && .rightHidden}}on-swipeleft({minX:-80,bind:'.rightPull'})="@.set('rightHidden', false)"{{/if}}
          class-rshell-overflow="~/centerOverflow"
        >{{yield ._center}}</div>
      {{/if}}
      {{#if ._right}}
        <div class-rshell-right as-tracked=`right`
          {{#if ._rightA}}{{yield ._rightA}}{{/if}}
          on-swiperight({bind:'.rightPush'})="@.set('rightHidden', true)"
          {{#if .rightPull}}style-transition=none style-transform="translate({{ 100 - (.rightPull > 100 ? 100 : .rightPull)}}%)"{{/if}}
          {{#if .rightPush}}style-transition=none style-transform="translate({{.rightPush > 100 ? 100 : .rightPush}}%)"{{/if}}
          class-rshell-overflow="~/rightOverflow"
        >{{yield ._right}}</div>
      {{/if}}
    </div>
    {{#if ._bottom}}<div class-rshell-bottom {{#if ._bottomA}}{{yield ._bottomA}}{{/if}} class-rshell-overflow="~/bottomOverflow">{{yield ._bottom}}</div>{{/if}}
  </div>
  {{#if ._leftPop}}<div class-rshell-left-pop {{#if ._leftPopA}}{{yield ._leftPopA}}{{/if}}>{{yield ._leftPop}}</div>{{/if}}
  {{#if ._rightPop}}<div class-rshell-right-pop {{#if ._rightPopA}}{{yield ._rightPopA}}{{/if}}>{{yield ._rightPop}}</div>{{/if}}
</div>

<script>
  import Ractive from 'ractive';
  import { left as swipeleft, right as swiperight } from './event-swipe';
  import globalRegister from './globalRegister';

  export class Shell extends Ractive {
    constructor(opts) { super(opts); }

    adaptSize(reinit) {
      if (reinit) {
        if (this._media) this._media.cancel();
        initMediaListener(this);
      } else {
        this._media && this._media.fn();
      }
    }

    sizeInPx(size) {
      if (!this.sizer) return 160;
      this.sizer.style.width = typeof size === 'number' ? `${size}px` : size;
      return this.sizer.clientWidth;
    }

    relativeSize(size, rel = '1em') {
      if (!this.sizer) return 10;
      return this.sizeInPx(size) / this.sizeInPx(rel);
    }
  }

  Ractive.extendWith(Shell, {
    template: $TEMPLATE, css: $CSS,
    attributes: ['adaptive'],
    use: [ swipeleft, swiperight ],
    decorators: {
      tracked(node, name) {
        this[name] = node;
        return { teardown() { this[name] = undefined; } };
      }
    },
    cssId: 'rshell',
    noCssTransform: true,
    computed: {
      blockableLeft() {
        return this.get('_left') && (this.get('leftOver') || this.get('_leftOver'));
      },
      blockableRight() {
        return this.get('_right') && (this.get('rightOver') || this.get('_rightOver'));
      },
      blocked() {
        return (this.get('blockableLeft') && !(this.get('leftHidden')) || (this.get('blockableRight') && !this.get('rightHidden'))) || this.get('leftPop') || this.get('rightPop');
      }
    },
    on: {
      construct,
      config() {
        if (this._items) this.set(this._items);
      },
      init() {
        if (this.get('@style.shell.sides.initialTimeout') && (this.get('rightOver') || this.get('leftOver'))) {
          setTimeout(() => {
            if (this.get('rightOver')) this.set('rightHidden', true);
            if (this.get('leftOver')) this.set('leftHidden', true);
          }, this.get('@style.shell.sides.initialTimeout') || 1500);
        } else {
            if (this.get('rightOver')) this.set('rightHidden', true);
            if (this.get('leftOver')) this.set('leftHidden', true);
        }
      },
      complete() {
        initMediaListener(this);
      },
      unrender() {
        if (this._media) this._media.cancel();
      }
    },
    observe: {
      'leftHidden rightHidden': {
        handler(v, o, k) {
          if (~k.indexOf('left') && !this.get('leftOver') && !this.get('_leftOver') || ~k.indexOf('right') && !this.get('rightOver') && !this.get('_rightOver')) {
            setTimeout(() => {
              this._media && this._media.listener && this._media.listener.silence();
              this._media && this._media.observer && this._media.observer.silence();
              this.fire('resize')
              this._media && this._media.listener && this._media.listener.resume();
              this._media && this._media.observer && this._media.observer.resume();
            }, (this.get('shell.slide.ms') || 400) + 10);
          }
        },
        defer: true,
        init: false
      }
    }
  });

  const parts = ['top', 'bottom', 'center', 'left', 'right', 'left-pop', 'right-pop'];
  const skipAttrs = ['hidden', 'primary', 'over', 'popped', 'overflow', 'forced'];
  function construct() {
    const cmp = this.component;
    if ( !cmp ) return;

    const tpl = cmp.template.f || [];
    const attrs = cmp.template.m ? cmp.template.m.slice() : [];
    const t = cmp.template;
    cmp.template = { e: t.e, f: t.f, t: t.t, m: attrs };

    const items = {};

    tpl.forEach(e => {
      if (~parts.indexOf(e.e)) {
        const name = e.e === 'left-pop' ? 'leftPop' : e.e === 'right-pop' ? 'rightPop' : e.e;
        items[`_${name}`] = { t: e.f };
        if (e.m) {
          const as = e.m.filter(a => !~skipAttrs.indexOf(a.n));

          if (as.length) {
            items[`_${name}A`] = { t: as };
          }

          if (as.length !== e.m.length) {
            let a = e.m.find(a => a.n === 'hidden');
            if (a) attrs.push({ t: 13, n: `${name}Hidden`, f: a.f });
            a = e.m.find(a => a.n === 'over');
            if (a) attrs.push({ t: 13, n: `${name}Over`, f: a.f });
            a = e.m.find(a => a.n === 'primary');
            if (a) attrs.push({ t: 13, n: `_${name}Primary`, f: a.f });
            if (~e.e.indexOf('-pop')) {
              a = e.m.find(a => a.n === 'popped');
              if (a) attrs.push({ t: 13, n: name, f: a.f });
            }
            a = e.m.find(a => a.n === 'overflow');
            if (a) attrs.push({ t: 13, n: `${name}Overflow`, f: a.f });
            a = (e.e === 'left' || e.e === 'right') && e.m.find(a => a.n === 'forced');
            if (a) attrs.push({ t: 13, n: `_${name}Over`, f: a.f });
          }
        }
      }
    });

    this._items = items;
  }

  function initMediaListener(r) {
    if (typeof window === 'undefined') return;
    if (!r.left && !r.right) return;
    if (r._media) return r._media.fn;
    let inited = 0;
    let tm;

    const media = {
      fn() {
        const sizes = {
          left:  !r.get('leftOver') && r.left && r.left.clientWidth || 0,
          right: !r.get('rightOver') && r.right && r.right.clientWidth || 0
        };
        if (sizes.left) sizes.left = r.relativeSize(sizes.left);
        if (sizes.right) sizes.right = r.relativeSize(sizes.right);

        const outer = r.relativeSize('100%');
        const primary = r.get('_rightPrimary') ? 'right' : 'left';
        const secondary = primary === 'right' ? 'left' : 'right';
        const medium = r.relativeSize(r.get('@style.break.medium') || '60rem', '1rem');

        const overs = { _leftOver: false, _rightOver: false };
        const hides = { leftHidden: r.get('leftOver'), rightHidden: r.get('rightOver') };

        if (!inited) {
          overs.leftHidden = false;
          overs.rightHidden = false;
        }

        let w = outer - sizes.left - sizes.right;
        if (w <= medium) {
          w += sizes[secondary];
          hides[`${secondary}Hidden`] = true;
          overs[`_${secondary}Over`] = true;
          if (w <= medium) {
            hides[`${primary}Hidden`] = true;
            overs[`_${primary}Over`] = true;
          }
        }

        r.set(overs);

        if (!inited) {
          inited = 1;
          setTimeout(() => {
            inited = 2;
            r.set(hides);
          }, r.get('@style.shell.sides.initialTimeout') || 1500);
        } else if (inited === 2) {
          r.set(hides);
        }

        if (tm) clearTimeout(tm);
        tm = setTimeout(() => {
          if (media.listener) media.listener.silence();
          r.fire('resize');
          if (media.listener) media.listener.resume();
          tm = 0;
        }, (r.get('shell.slide.ms') || 400) + 100);
      },
      cancel() {
        r._media = null;
        window.removeEventListener('resize', media.fn);
        if (media.observer) media.observer.cancel();
        if (media.listener) media.listener.cancel();
      }
    }

    window.addEventListener('resize', media.fn);
    media.observer = r.observe('@style leftOver rightOver _leftPrimary _rightPrimary', media.fn, { init: false });
    if (r.get('adaptive')) media.listener = r.root.on('*.resize', media.fn);

    r._media = media;

    r._media.fn();
  }

  export function plugin(opts = {}) {
    return function({ instance }) {
      instance.components[opts.name || 'shell'] = Shell;
    }
  }

  globalRegister('RMShell', 'components', Shell);

  export default plugin;
</script>

<script rel="css">
  const left = data('shell.left.width') || data('menu.width') || '18em';
  const right = data('shell.right.width') || data('menu.width') || '18em';
  return `
  .rshell {
    width: 100%;
    height: 100%;
    position: absolute;
    overflow: hidden;
  }
  .rshell-sizer {
    position: absolute;
  }
  .rshell-modal {
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    opacity: 0;
    background-color: #000;
    z-index: -1;
    transition: opacity ${data('shell.slide.ms') || 400}ms ease-in-out, z-index 0s linear ${data('shell.slide.ms') || 400}ms;
  }
  .rshell-modal.rshell-blocked {
    opacity: 0.5;
    z-index: 3;
    transition: opacity ${data('shell.slide.ms') || 400}ms ease-in-out, z-index 0s linear;
  }
  .rshell-main {
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 1;
  }

  .rshell-middle {
    flex-grow: 1;
    position: relative;
  }

  .rshell-left, .rshell-right {
    position: absolute;
    top: 0;
    box-sizing: border-box;
    height: 100%;
    overflow: auto;
    z-index: 4;
    background-color: ${data('shell.menu.bg') || data('bg1') || 'inherit'};
    transition: transform ${data('shell.slide.ms') || 400}ms ease-in-out;
  }
  .rshell-left {
    left: 0;
    width: ${left};
  }
  .rshell-right {
    right: 0;
    width: ${right};
  }
  .rshell-left-hidden > .rshell-left {
    transform: translateX(-100%);
  }
  .rshell-right-hidden > .rshell-right {
    transform: translateX(100%);
  }
  .rshell-has-right > .rshell-right,
  .rshell-has-left > .rshell-left {
    z-index: 2;
  }
  .rshell-left-popped > .rshell-main > .rshell-middle > .rshell-left,
  .rshell-left-popped > .rshell-main > .rshell-middle > .rshell-right,
  .rshell-right-popped > .rshell-main > .rshell-middle > .rshell-left,
  .rshell-right-popped > .rshell-main > .rshell-middle > .rshell-right {
    z-index: 2;
  }

  .rshell-left-pop, .rshell-right-pop {
    z-index: 5;
    transition: transform ${data('shell.slide.ms') || 400}ms ease-in-out;
    position: absolute;
    top: 0;
    bottom: 0;
  }
  .rshell-left-pop {
    transform: translateX(-100%);
  }
  .rshell-left-popped > .rshell-left-pop {
    transform: none;
  }

  .rshell-right-pop {
    transform: translateX(100%);
    right: 0;
  }
  .rshell-right-popped > .rshell-right-pop {
    transform: none;
  }

  .rshell-center {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    box-sizing: border-box;
    transition: left ${data('shell.slide.ms') || 400}ms ease-in-out, width ${data('shell.slide.ms') || 400}ms ease-in-out;
    height: 100%;
    width: 100%;
    flex-grow: 1;
    overflow: auto;
  }
  .rshell-has-left > .rshell-center {
    width: calc(100% - ${left});
    left: ${left};
  }
  .rshell-has-right > .rshell-center {
    width: calc(100% - ${right});
    left: 0;
  }
  .rshell-has-left.rshell-has-right > .rshell-center {
    width: calc(100% - ${left} - ${right});
    left: ${left};
  }
  .rshell-has-left.rshell-left-hidden > .rshell-center {
    width: 100%;
    left: 0;
  }
  .rshell-has-right.rshell-right-hidden > .rshell-center {
    width: 100%;
  }
  .rshell-has-left.rshell-has-right.rshell-left-hidden > .rshell-center {
    width: calc(100% - ${right});
    left: 0;
  }
  .rshell-has-left.rshell-has-right.rshell-right-hidden > .rshell-center {
    width: calc(100% - ${left});
    left: ${left};
  }
  .rshell-has-left.rshell-has-right.rshell-left-hidden.rshell-right-hidden > .rshell-center {
    width: 100%;
    left: 0;
  }

  .rshell-overflow {
    overflow: visible;
  }
  `;
</script>
